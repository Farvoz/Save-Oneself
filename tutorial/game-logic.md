# Логика игры "Save Oneself"

## Общее описание
"Save Oneself" - это карточная стратегическая игра, где игрок пытается выжить на острове и привлечь внимание проходящего корабля. Игра проходит на сетке с ограничением в максимум 4 уникальных ряда и 4 уникальных столбца. Игрок начинает с 16 жизнями и должен выжить, размещая карты и создавая сигналы для привлечения корабля.

## Основные компоненты

### Карты
Игра использует два типа карт:

1. 
**Двусторонние карты**:
   - Каждая карта имеет две стороны: тыльную (`back`) и лицевую (`front`)
   - В начале игры используется тыльная сторона, содержащая базовые ресурсы и инструменты
   - Для переворота карты на лицевую сторону необходимо выполнить определённые требования
   - Тыльная сторона может указывать направление для размещения корабля
   - Свойства тыльной стороны:
     - `lives` — количество жизней, которые даёт карта (может быть отрицательным)
     - `direction` — направление для корабля (NE, NW, SE, SW) — опционально
     - `id` — уникальный идентификатор
     - `requirements` — требования для переворота (ID нужной карты)
     - `requirementsText` — текст требований для отображения
     - `type` — тип карты ('back')
     - `emoji` — эмодзи для визуального отображения
     - `description` — описание карты и её эффектов
     - Обработчики событий: `onPlace`, `onRoundStart`, `canFlip`
   - Лицевая сторона открывается при выполнении требований и представляет собой улучшенную версию базовой карты
   - Свойства лицевой стороны:
     - `lives` — количество дополнительных жизней
     - `id` — уникальный идентификатор
     - `type` — тип карты ('front')
     - `emoji` — эмодзи для визуального отображения
     - `score` — очки, которые даёт карта при подсчёте финального результата
     - `description` — описание карты и её эффектов
     - Обработчики событий: `onFlip`, `onBeforeShipMove`, `onShipMove`, `onRoundStart`

2. **Карта корабля** (`ship`):
   - Специальная карта, которая появляется при размещении карты с направлением
   - Имеет тип 'ship' и уникальную логику движения

### Корабль
- Специальная карта типа 'ship', которая появляется при размещении карты с направлением
- Размещается в одном из четырёх углов относительно игрового поля (NW, NE, SW, SE)
- Имеет `cornerManager` для управления движением по периметру острова
- Имеет свойство `skipMove` для контроля движения (изначально true)
- Имеет `hasTurned` для отслеживания поворотов при наличии карты 'ship-sighted'
- Движется по орбите вокруг острова в зависимости от направления
- Отображается с направлением движения (стрелками: ⬇️, ⬅️, ⬆️, ➡️)
- Ключевой элемент для победы - игрок должен привлечь его внимание

## Архитектура состояний игры

Игра использует конечный автомат (state machine) для управления игровым процессом. Основное состояние `playing` содержит подсостояния, которые циклически повторяются в течение игры.

### Основные состояния

#### 1. **startOfRound** - Начало раунда
- **Входные действия:**
  - Сброс флагов `hasPlacedCard` и `hasMoved`
  - Вызов обработчиков `onRoundStart` для всех карт на поле
- **Автоматический переход:** всегда переходит в `moving`
- **Логика:** Подготовка к новому раунду, обновление состояния карт

#### 2. **moving** - Фаза перемещения
- **События:**
  - `MOVE_PLAYER`: Перемещение игрока на новую позицию
    - Действия: вызов `movePlayer()`, уменьшение `movesLeft`, установка `hasMoved: true`
    - Переход: `checkingCardPlacement`
  - `SKIP_MOVES`: Пропуск оставшихся ходов
    - Условие: `context.hasMoved` должно быть true
    - Переход: `decreasingLives`
- **Логика:** Игрок может перемещаться или пропустить ходы, если уже сделал ход. При перемещении количество оставшихся ходов уменьшается.

#### 3. **checkingCardPlacement** - Проверка размещения карты
- **Автоматические переходы (после 0ms):**
  - `gameOver`: если есть сообщение о завершении игры
  - `placingCardAndShip`: если на позиции игрока нет карты И карта ещё не размещена в этом раунде
  - `checkingCardEffects`: в остальных случаях
- **Логика:** Определение необходимости размещения новой карты

#### 4. **placingCardAndShip** - Размещение карты и корабля
- **Входные действия:**
  - Размещение карты через `placeCard()`
  - Проверка необходимости размещения корабля через `placeShip()`
  - Установка флага `hasPlacedCard: true`
- **Автоматический переход:** `checkingCardEffects`
- **Логика:** Размещение карты и корабля (если требуется)

#### 5. **checkingCardEffects** - Проверка эффектов карт
- **Входные действия:**
  - Вызов обработчика `onPlace` для текущей карты
- **Автоматический переход:** `checkingMoveResult`
- **Логика:** Обработка эффектов размещённой карты

#### 6. **checkingMoveResult** - Проверка результата хода
- **Автоматические переходы (после 500ms):**
  - `gameOver`: если есть сообщение о завершении игры
  - `moving`: если у игрока остались ходы (`movesLeft > 0`)
  - `decreasingLives`: если ходы закончились
- **Логика:** Определение следующего действия на основе оставшихся ходов. Задержка 500ms для визуального отображения результата хода.

#### 7. **decreasingLives** - Уменьшение жизней
- **Входные действия:**
  - Уменьшение жизней на 1 через `updateLives()`
  - Логирование изменения жизней
- **Автоматические переходы (после 0ms):**
  - `gameOver`: если жизни <= 0 (поражение)
  - `checkingFlippable`: если есть карты для переворота
  - `shipMoving`: в остальных случаях
- **Логика:** Обработка уменьшения жизней и определение следующей фазы

#### 8. **checkingFlippable** - Фаза переворота карт
- **События:**
  - `FLIP_CARD`: Переворот карты
    - Условие: карта может быть перевёрнута (`canFlipCard()`)
    - Действия: вызов `card.flip()`, логирование
    - Переход: `shipMoving`
  - `SKIP_PHASE`: Пропуск фазы
    - Переход: `shipMoving`
- **Логика:** Возможность переворота карт при выполнении требований

#### 9. **shipMoving** - Движение корабля
- **Входные действия:**
  - Вызов обработчиков `onBeforeShipMove` для всех карт
  - Проверка флага `skipMove` корабля (если true, сброс флага без движения)
  - Движение корабля через `moveShip()` (если не на паузе)
  - Логирование позиции корабля
- **Автоматические переходы (после 500ms):**
  - `gameOver` (победа): если `checkVictory()` возвращает true
  - `gameOver` (поражение): если `checkDefeat()` возвращает true (корабль уплыл слишком далеко)
  - `checkingShipEffects`: в остальных случаях
- **Логика:** Автоматическое движение корабля по орбите вокруг острова и проверка условий победы/поражения

#### 10. **checkingShipEffects** - Проверка эффектов при движении корабля
- **Входные действия:**
  - Вызов обработчиков `onShipMove` для всех карт
- **Автоматический переход:** `startOfRound`
- **Логика:** Обработка эффектов карт при движении корабля и завершение раунда

#### 11. **gameOver** - Завершение игры
- **Тип:** финальное состояние
- **Логика:** Игра завершена, отображение результата

## Детальная логика переходов

### Цикл раунда
```
startOfRound → moving → checkingCardPlacement → placingCardAndShip → 
checkingCardEffects → checkingMoveResult → [moving (если есть ходы) или decreasingLives] → 
checkingFlippable → shipMoving → checkingShipEffects → startOfRound
```

### Условия завершения игры
1. **Победа:** `checkVictory()` возвращает true
2. **Поражение по жизням:** `lives <= 0`
3. **Поражение по кораблю:** корабль уплыл слишком далеко
4. **Другие условия:** наличие `gameOverMessage`

### Обработчики карт
- **`onRoundStart`:** Вызывается в начале каждого раунда для всех карт
- **`onPlace`:** Вызывается при размещении карты для текущей карты
- **`onShipMove`:** Вызывается при движении корабля для всех карт

## Механики

### Размещение карт
- Карты размещаются на пустых клетках сетки
- Ограничения:
  - Максимум 4 уникальных ряда и 4 уникальных столбца
  - Позиция должна быть валидной относительно корабля (если корабль есть на поле)
  - Должна соседствовать с позицией игрока
  - В один раунд можно разместить только одну карту
  - Нельзя разместить карту, если колода пуста
- При размещении карты с направлением автоматически размещается корабль

### Переворот карт
Карту можно перевернуть, если:
- Это карта тыльной стороны (type === 'back')
- Выполнены все требования
- Текущая фаза - фаза переворота (`checkingFlippable`)

Требования для переворота:
- **Базовые требования:** наличие определённой карты на поле (по ID)
- **Специальные требования:**
  - Для карты 'bottle' - корабль есть на поле и в состоянии `skipMove = true`
  - Для карт 'telescope' и 'rocks' - игрок должен находиться на карте 'higher-ground'
  - Для карт 'map-r' и 'map-c' - игрок должен находиться на пересечении рядов карт 'map-r' и 'map-c'
  - Для карты 'storm' - автоматически переворачивается при размещении 13-й карты на поле

### Движение
- Игрок может перемещаться на соседние клетки
- При перемещении на пустую клетку размещается новая карта из колоды
- При перемещении на существующую карту просто обновляется позиция игрока
- При каждом перемещении количество оставшихся ходов (`movesLeft`) уменьшается на 1
- Проверяются все ограничения размещения
- Позиция игрока важна для некоторых механик (например, переворот карт 'telescope' и 'rocks')
- Игрок может пропустить оставшиеся ходы, если уже сделал хотя бы один ход

### Победа
Игрок побеждает, если выполняется одно из условий:
1. **SOS сигнал:** На поле есть перевёрнутая карта 'sos' И корабль находится в том же ряду
2. **Маяк:** На поле есть перевёрнутая карта 'lit-beacon' И корабль находится в том же столбце
3. **Сообщение в бутылке:** На поле есть перевёрнутая карта 'message' И корабль находится на соседней клетке (НЕ в углу острова)

### Поражение
Игрок проигрывает, если выполняется одно из условий:
1. **Закончились жизни:** Количество жизней достигло нуля или меньше
2. **Корабль уплыл:** Корабль уплыл слишком далеко от игрового поля (выходит за допустимую орбиту)
3. **Колода пуста:** Колода карт закончилась и игрок пытается переместиться на пустую клетку

## Состояние игры
- `lives` - количество жизней (начальное значение 16, максимум 16)
- `positionSystem` - система управления позициями карт и корабля
- `playerPosition` - текущая позиция игрока
- `deck` - колода карт тыльной стороны (изначально содержит все карты из CARD_DATA)
- `hasPlacedCard` - флаг размещения карты в текущем раунде
- `movesLeft` - количество оставшихся ходов (изначально 0)
- `hasMoved` - флаг перемещения в текущем раунде
- `gameOverMessage` - сообщение о завершении игры
- `isVictory` - флаг победы (true для победы, false для поражения)
- `showStartTooltip` - флаг отображения подсказки в начале игры

## Подсчёт очков
Финальный счёт рассчитывается как сумма:
- **Очки от перевёрнутых карт:** сумма значений `score` всех перевёрнутых карт на поле
- **Оставшиеся жизни:** количество жизней игрока на момент окончания игры
- **Бонусные очки:** 1 очко за каждые 4 размещённые карты (не включая корабль)

Примеры очков за карты:
- `torch` (🕯️): 2 очка
- `spear` (🗡️): 2 очка  
- `shelter` (🏠): 2 очка
- `message` (📜): 3 очка
- `sos` (🆘): 5 очков
- `lit-beacon` (🔥): 7 очков
- `ship-sighted` (🚢): 1 очко
- `treasure` (💎): 10 очков

## Особенности реализации

### State Machine
- Использует библиотеку XState для управления состояниями
- Каждое состояние имеет чётко определённые входные действия и переходы
- Автоматические переходы происходят через `after` с задержкой 0ms или 500ms
- События (`MOVE_PLAYER`, `FLIP_CARD`, `SKIP_MOVES`, `SKIP_PHASE`) обрабатываются через `on`

### Обработчики карт
- Система позволяет картам реагировать на различные события игры
- Обработчики вызываются в определённые моменты игрового цикла
- Поддерживается как глобальное применение эффектов, так и локальное для конкретной карты

### Логирование
- Все важные действия логируются через `gameLogger`
- Логи содержат контекстную информацию для отладки
- Помогает отслеживать поток выполнения игры

## Специальные механики карт

### Обработчики событий карт
- **`onPlace`**: Вызывается при размещении карты (например, `water`, `pig`, `storm`, `mirage`)
- **`onFlip`**: Вызывается при перевороте карты (например, `shelter`, `fish`, `waterfall`, `meat`)
- **`onRoundStart`**: Вызывается в начале каждого раунда (например, `storm`, `compass`)
- **`onBeforeShipMove`**: Вызывается перед движением корабля (например, `ship-sighted`, `pirates`)
- **`onShipMove`**: Вызывается при движении корабля (например, `sea-serpent`)
- **`canFlip`**: Кастомная логика проверки возможности переворота (например, `bottle`, `telescope`, `rocks`, `map-r`, `map-c`)

### Особые эффекты
- **Карта 'compass'**: Даёт 2 хода вместо 1 в каждом раунде
- **Карта 'ship-sighted'**: Позволяет кораблю повернуть на углу (только один раз)
- **Карта 'pirates'**: Удаляет корабль с поля, когда он начинает двигаться
- **Карта 'sea-serpent'**: Заставляет корабль перескочить одну клетку
- **Карта 'mirage'**: Меняется местами с самой дальней картой на поле
- **Карта 'storm'**: Автоматически переворачивается при размещении 13-й карты
- **Карта 'tornado'**: Переворачивает обратно себя, `shelter` и `lit-beacon` при размещении 13-й карты 