# Логика игры "Save Oneself"

## Общее описание
"Save Oneself" - это карточная стратегическая игра, где игрок пытается выжить на острове и привлечь внимание проходящего корабля. Игра проходит на сетке с ограничением в 4 уникальных ряда и 4 уникальных столбца.

## Основные компоненты

### Карты
Игра использует два типа карт:
1. **Карты тыльной стороны** (`INITIAL_DECK`):
   - Содержат базовые ресурсы и инструменты
   - Имеют требования для переворота
   - Могут указывать направление для размещения корабля
   - Каждая карта имеет:
     - `lives` - количество жизней, которые даёт карта
     - `direction` - направление для корабля (NE, NW, SE, SW)
     - `id` - уникальный идентификатор
     - `requirements` - требования для переворота
     - `type` - тип карты ('back')
     - `emoji` - эмодзи для визуального отображения
     - `description` - описание карты и её эффектов

2. **Карты лицевой стороны** (`INITIAL_FRONT_DECK`):
   - Открываются при выполнении требований
   - Представляют собой улучшенные версии базовых карт
   - Имеют:
     - `lives` - количество дополнительных жизней
     - `backId` - связь с картой тыльной стороны
     - `id` - уникальный идентификатор
     - `type` - тип карты ('front')
     - `emoji` - эмодзи для визуального отображения
     - `score` - очки, которые даёт карта при подсчёте финального результата
     - `description` - описание карты и её эффектов

### Корабль
- Специальная карта, которая появляется при размещении карты с направлением
- Размещается в одном из четырёх углов относительно игрового поля
- Имеет свойство `skipMove` для контроля движения
- Имеет `cornerManager` для определения границ игрового поля
- Имеет `hasTurned` для отслеживания поворотов при наличии карты 'ship-sighted'
- Отображается с направлением движения (стрелками)
- Ключевой элемент для победы

## Архитектура состояний игры

Игра использует конечный автомат (state machine) для управления игровым процессом. Основное состояние `playing` содержит подсостояния, которые циклически повторяются в течение игры.

### Основные состояния

#### 1. **startOfRound** - Начало раунда
- **Входные действия:**
  - Сброс флагов `hasPlacedCard` и `hasMoved`
  - Вызов обработчиков `onRoundStart` для всех карт на поле
- **Автоматический переход:** всегда переходит в `moving`
- **Логика:** Подготовка к новому раунду, обновление состояния карт

#### 2. **moving** - Фаза перемещения
- **События:**
  - `MOVE_PLAYER`: Перемещение игрока на новую позицию
    - Действия: вызов `movePlayer()`, логирование
    - Переход: `checkingCardPlacement`
  - `SKIP_MOVES`: Пропуск оставшихся ходов
    - Условие: `context.hasMoved` должно быть true
    - Переход: `decreasingLives`
- **Логика:** Игрок может перемещаться или пропустить ходы, если уже сделал ход

#### 3. **checkingCardPlacement** - Проверка размещения карты
- **Автоматические переходы (после 0ms):**
  - `gameOver`: если есть сообщение о завершении игры
  - `placingCardAndShip`: если на позиции игрока нет карты И карта ещё не размещена в этом раунде
  - `checkingCardEffects`: в остальных случаях
- **Логика:** Определение необходимости размещения новой карты

#### 4. **placingCardAndShip** - Размещение карты и корабля
- **Входные действия:**
  - Размещение карты через `placeCard()`
  - Проверка необходимости размещения корабля через `placeShip()`
  - Установка флага `hasPlacedCard: true`
- **Автоматический переход:** `checkingCardEffects`
- **Логика:** Размещение карты и корабля (если требуется)

#### 5. **checkingCardEffects** - Проверка эффектов карт
- **Входные действия:**
  - Вызов обработчика `onPlace` для текущей карты
- **Автоматический переход:** `checkingMoveResult`
- **Логика:** Обработка эффектов размещённой карты

#### 6. **checkingMoveResult** - Проверка результата хода
- **Автоматические переходы (после 0ms):**
  - `gameOver`: если есть сообщение о завершении игры
  - `moving`: если у игрока остались ходы (`movesLeft > 0`)
  - `decreasingLives`: если ходы закончились
- **Логика:** Определение следующего действия на основе оставшихся ходов

#### 7. **decreasingLives** - Уменьшение жизней
- **Входные действия:**
  - Уменьшение жизней на 1 через `updateLives()`
  - Логирование изменения жизней
- **Автоматические переходы (после 0ms):**
  - `gameOver`: если жизни <= 0 (поражение)
  - `checkingFlippable`: если есть карты для переворота
  - `shipMoving`: в остальных случаях
- **Логика:** Обработка уменьшения жизней и определение следующей фазы

#### 8. **checkingFlippable** - Фаза переворота карт
- **События:**
  - `FLIP_CARD`: Переворот карты
    - Условие: карта может быть перевёрнута (`canFlipCard()`)
    - Действия: вызов `card.flip()`, логирование
    - Переход: `shipMoving`
  - `SKIP_PHASE`: Пропуск фазы
    - Переход: `shipMoving`
- **Логика:** Возможность переворота карт при выполнении требований

#### 9. **shipMoving** - Движение корабля
- **Входные действия:**
  - Движение корабля через `moveShip()`
  - Логирование позиции корабля
- **Автоматические переходы (после 500ms):**
  - `gameOver` (победа): если `checkVictory()` возвращает true
  - `gameOver` (поражение): если корабль уплыл слишком далеко
  - `checkingShipEffects`: в остальных случаях
- **Логика:** Автоматическое движение корабля и проверка условий победы/поражения

#### 10. **checkingShipEffects** - Проверка эффектов при движении корабля
- **Входные действия:**
  - Вызов обработчиков `onShipMove` для всех карт
- **Автоматический переход:** `startOfRound`
- **Логика:** Обработка эффектов карт при движении корабля и завершение раунда

#### 11. **gameOver** - Завершение игры
- **Тип:** финальное состояние
- **Логика:** Игра завершена, отображение результата

## Детальная логика переходов

### Цикл раунда
```
startOfRound → moving → checkingCardPlacement → placingCardAndShip → 
checkingCardEffects → checkingMoveResult → [moving (если есть ходы) или decreasingLives] → 
checkingFlippable → shipMoving → checkingShipEffects → startOfRound
```

### Условия завершения игры
1. **Победа:** `checkVictory()` возвращает true
2. **Поражение по жизням:** `lives <= 0`
3. **Поражение по кораблю:** корабль уплыл слишком далеко
4. **Другие условия:** наличие `gameOverMessage`

### Обработчики карт
- **`onRoundStart`:** Вызывается в начале каждого раунда для всех карт
- **`onPlace`:** Вызывается при размещении карты для текущей карты
- **`onShipMove`:** Вызывается при движении корабля для всех карт

## Механики

### Размещение карт
- Карты размещаются на пустых клетках сетки
- Ограничения:
  - Максимум 4 уникальных ряда и 4 уникальных столбца
  - Позиция должна быть валидной относительно корабля
  - Должна соседствовать с позицией игрока
  - В один раунд можно разместить только одну карту

### Переворот карт
Карту можно перевернуть, если:
- Это карта тыльной стороны
- Выполнены все требования
- Текущая фаза - фаза переворота

Требования для переворота:
- Наличие определённой карты на поле
- Для карты с `_ship-set-sail` - корабль есть на поле и в состоянии skipMove = true
- Для карты 'higher-ground' - игрок должен находиться на карте 'higher-ground'
- Для карты с требованием '_map' - игрок должен находиться на пересечении рядов карт 'map-r' и 'map-c'

### Движение
- Игрок может перемещаться на соседние клетки
- При перемещении на пустую клетку размещается новая карта
- Проверяются все ограничения размещения
- Позиция игрока важна для некоторых механик

### Победа
Игрок побеждает, если:
- На поле есть перевёрнутая карта 'sos' И корабль находится в том же ряду
- ИЛИ
- На поле есть перевёрнутая карта 'lit-beacon' И корабль находится в том же столбце
- ИЛИ
- На поле есть перевёрнутая карта 'message' И корабль находится на соседней клетке (не в углу)

### Поражение
Игрок проигрывает, если:
- Количество жизней достигло нуля
- Корабль уплыл слишком далеко от игрового поля
- Колода карт закончилась

## Состояние игры
- `lives` - количество жизней (максимум 16)
- `positionSystem` - система управления позициями карт
- `playerPosition` - текущая позиция игрока
- `deck` - колода карт тыльной стороны
- `frontDeck` - колода карт лицевой стороны
- `hasPlacedCard` - флаг размещения карты в текущем раунде
- `movesLeft` - количество оставшихся ходов
- `hasMoved` - флаг перемещения в текущем раунде
- `gameOverMessage` - сообщение о завершении игры
- `isVictory` - флаг победы

## Подсчёт очков
Финальный счёт рассчитывается как сумма:
- Очков от перевёрнутых карт (если у карты есть свойство `score`)
- Оставшихся жизней
- Бонусных очков (1 очко за каждые 4 размещённые карты)

## Особенности реализации

### State Machine
- Использует библиотеку XState для управления состояниями
- Каждое состояние имеет чётко определённые входные действия и переходы
- Автоматические переходы происходят через `after` с задержкой 0ms или 500ms
- События (`MOVE_PLAYER`, `FLIP_CARD`, `SKIP_MOVES`, `SKIP_PHASE`) обрабатываются через `on`

### Обработчики карт
- Система позволяет картам реагировать на различные события игры
- Обработчики вызываются в определённые моменты игрового цикла
- Поддерживается как глобальное применение эффектов, так и локальное для конкретной карты

### Логирование
- Все важные действия логируются через `gameLogger`
- Логи содержат контекстную информацию для отладки
- Помогает отслеживать поток выполнения игры 