# Логика игры "Save Oneself"

## Общее описание
"Save Oneself" - это карточная стратегическая игра, где игрок пытается выжить на острове и привлечь внимание проходящего корабля. Игра проходит на сетке с ограничением в 4 уникальных ряда и 4 уникальных столбца.

## Основные компоненты

### Карты
Игра использует два типа карт:
1. **Карты тыльной стороны** (`INITIAL_DECK`):
   - Содержат базовые ресурсы и инструменты
   - Имеют требования для переворота
   - Могут указывать направление для размещения корабля
   - Каждая карта имеет:
     - `lives` - количество жизней, которые даёт карта
     - `direction` - направление для корабля (NE, NW, SE, SW)
     - `id` - уникальный идентификатор
     - `requirements` - требования для переворота
     - `type` - тип карты ('back')
     - `emoji` - эмодзи для визуального отображения
     - `description` - описание карты и её эффектов

2. **Карты лицевой стороны** (`INITIAL_FRONT_DECK`):
   - Открываются при выполнении требований
   - Представляют собой улучшенные версии базовых карт
   - Имеют:
     - `lives` - количество дополнительных жизней
     - `backId` - связь с картой тыльной стороны
     - `id` - уникальный идентификатор
     - `type` - тип карты ('front')
     - `emoji` - эмодзи для визуального отображения
     - `score` - очки, которые даёт карта при подсчёте финального результата
     - `description` - описание карты и её эффектов

### Корабль
- Специальная карта, которая появляется при размещении карты с направлением
- Размещается в одном из четырёх углов относительно игрового поля
- Имеет свойство `skipMove` для контроля движения
- Имеет `cornerManager` для определения границ игрового поля
- Имеет `hasTurned` для отслеживания поворотов при наличии карты 'ship-sighted'
- Отображается с направлением движения (стрелками)
- Ключевой элемент для победы

## Игровые фазы
Игра разделена на несколько фаз, которые циклически повторяются:

1. **Начало раунда** (`startOfRound`):
   - Сброс флагов `hasPlacedCard` и `hasMoved`
   - Определение количества доступных ходов (2 если есть карта 'compass', иначе 1)

2. **Фаза перемещения** (`moving`):
   - Игрок может перемещаться на соседние клетки
   - При перемещении на пустую клетку размещается новая карта из колоды
   - Уменьшается количество оставшихся ходов
   - Устанавливается флаг `hasMoved`
   - Можно пропустить оставшиеся ходы, если уже был сделан ход

3. **Проверка размещения карты** (`checkingCardPlacement`):
   - Проверка условий завершения игры
   - Проверка необходимости размещения новой карты
   - Проверка эффектов карт

4. **Размещение карты и корабля** (`placingCardAndShip`):
   - Размещение новой карты на пустой клетке
   - Проверка необходимости размещения корабля
   - Установка флага `hasPlacedCard`

5. **Проверка эффектов карт** (`checkingCardEffects`):
   - Обработка эффекта 'mirage' (обмен позициями)
   - Обработка эффекта 'pirates' (удаление корабля)

6. **Проверка отрицательных эффектов** (`checkingNegativeEffects`):
   - Проверка карт с отрицательным эффектом на жизни
   - Проверка защиты от отрицательных эффектов (spear, shelter)

7. **Проверка результата хода** (`checkingMoveResult`):
   - Проверка условий завершения игры
   - Проверка необходимости проверки шторма
   - Проверка оставшихся ходов

8. **Проверка шторма** (`checkingStorm`):
   - Автоматический переворот карты шторма при размещении 13-й карты
   - Проверка защиты от шторма

9. **Уменьшение жизней** (`decreasingLives`):
   - Автоматическое уменьшение жизней на 1
   - Проверка условий поражения
   - Проверка наличия карт для переворота

10. **Фаза переворота карт** (`checkingFlippable`):
    - Возможность переворота карт при выполнении требований
    - Возможность пропуска фазы

11. **Движение корабля** (`shipMoving`):
    - Движение корабля в соответствии с направлением
    - Проверка эффекта пиратов
    - Проверка условий победы и поражения

## Механики

### Размещение карт
- Карты размещаются на пустых клетках сетки
- Ограничения:
  - Максимум 4 уникальных ряда и 4 уникальных столбца
  - Позиция должна быть валидной относительно корабля
  - Должна соседствовать с позицией игрока
  - В один раунд можно разместить только одну карту

### Переворот карт
Карту можно перевернуть, если:
- Это карта тыльной стороны
- Выполнены все требования
- Текущая фаза - фаза переворота

Требования для переворота:
- Наличие определённой карты на поле
- Для карты с `_ship-set-sail` - корабль есть на поле и в состоянии skipMove = true
- Для карты 'higher-ground' - игрок должен находиться на карте 'higher-ground'
- Для карты с требованием '_map' - игрок должен находиться на пересечении рядов карт 'map-r' и 'map-c'

### Движение
- Игрок может перемещаться на соседние клетки
- При перемещении на пустую клетку размещается новая карта
- Проверяются все ограничения размещения
- Позиция игрока важна для некоторых механик

### Победа
Игрок побеждает, если:
- На поле есть перевёрнутая карта 'sos' И корабль находится в том же ряду
- ИЛИ
- На поле есть перевёрнутая карта 'lit-beacon' И корабль находится в том же столбце
- ИЛИ
- На поле есть перевёрнутая карта 'message' И корабль находится на соседней клетке (не в углу)

### Поражение
Игрок проигрывает, если:
- Количество жизней достигло нуля
- Корабль уплыл слишком далеко от игрового поля
- Колода карт закончилась

## Состояние игры
- `lives` - количество жизней (максимум 16)
- `positionSystem` - система управления позициями карт
- `playerPosition` - текущая позиция игрока
- `deck` - колода карт тыльной стороны
- `frontDeck` - колода карт лицевой стороны
- `shipCard` - информация о корабле
- `hasPlacedCard` - флаг размещения карты в текущем раунде
- `movesLeft` - количество оставшихся ходов
- `hasMoved` - флаг перемещения в текущем раунде
- `gameOverMessage` - сообщение о завершении игры
- `isVictory` - флаг победы

## Подсчёт очков
Финальный счёт рассчитывается как сумма:
- Очков от перевёрнутых карт (если у карты есть свойство `score`)
- Оставшихся жизней
- Бонусных очков (1 очко за каждые 4 размещённые карты) 